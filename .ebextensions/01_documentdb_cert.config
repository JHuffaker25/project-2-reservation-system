files:
  "/tmp/global-bundle.pem":
    mode: "000644"
    owner: root
    group: root
    source: https://truststore.pki.rds.amazonaws.com/global/global-bundle.pem

container_commands:
  01_import_cert:
    command: |
      # Find the Java installation
      JAVA_HOME=$(readlink -f /usr/bin/java | sed "s:/bin/java::")
      KEYSTORE="$JAVA_HOME/lib/security/cacerts"

      echo "=== Certificate Import Debug Info ==="
      echo "JAVA_HOME: $JAVA_HOME"
      echo "KEYSTORE: $KEYSTORE"
      echo "Certificate file exists: $(test -f /tmp/global-bundle.pem && echo 'YES' || echo 'NO')"

      # Remove old certificate if it exists
      keytool -delete -alias documentdb-ca -keystore "$KEYSTORE" -storepass changeit -noprompt || true

      # Import the certificate into Java's truststore
      echo "Importing certificate..."
      keytool -import -trustcacerts -alias documentdb-ca -file /tmp/global-bundle.pem \
        -keystore "$KEYSTORE" -storepass changeit -noprompt

      # Verify the certificate was imported
      echo "Verifying certificate import..."
      keytool -list -alias documentdb-ca -keystore "$KEYSTORE" -storepass changeit -noprompt

      echo "=== Certificate Import Complete ==="
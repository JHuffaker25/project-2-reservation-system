files:
  "/tmp/global-bundle.pem":
    mode: "000644"
    owner: root
    group: root
    source: https://truststore.pki.rds.amazonaws.com/global/global-bundle.pem

container_commands:
  01_create_truststore_dir:
    command: |
      mkdir -p /var/app/current/certs
      echo "Created /var/app/current/certs directory"

  02_import_cert:
    command: |
      echo "=== DocumentDB Certificate Import Started ==="

      # Find all Java installations and import to each
      for JAVA_BIN in $(find /usr/lib/jvm -name java 2>/dev/null); do
        JAVA_HOME=$(dirname $(dirname $JAVA_BIN))
        KEYSTORE="$JAVA_HOME/lib/security/cacerts"

        if [ -f "$KEYSTORE" ]; then
          echo "Processing keystore: $KEYSTORE"

          # Remove old certificate if it exists
          keytool -delete -alias documentdb-ca -keystore "$KEYSTORE" -storepass changeit -noprompt 2>/dev/null || true

          # Import the certificate
          keytool -import -trustcacerts -alias documentdb-ca -file /tmp/global-bundle.pem \
            -keystore "$KEYSTORE" -storepass changeit -noprompt

          echo "Certificate imported to $KEYSTORE"
        fi
      done

      # Also import to Corretto if present (Amazon's OpenJDK distribution)
      for CORRETTO_HOME in /usr/lib/jvm/java-*-amazon-corretto*; do
        if [ -d "$CORRETTO_HOME" ]; then
          KEYSTORE="$CORRETTO_HOME/lib/security/cacerts"
          if [ -f "$KEYSTORE" ]; then
            echo "Processing Corretto keystore: $KEYSTORE"
            keytool -delete -alias documentdb-ca -keystore "$KEYSTORE" -storepass changeit -noprompt 2>/dev/null || true
            keytool -import -trustcacerts -alias documentdb-ca -file /tmp/global-bundle.pem \
              -keystore "$KEYSTORE" -storepass changeit -noprompt
            echo "Certificate imported to Corretto keystore"
          fi
        fi
      done

      # Copy certificate to app directory for reference
      cp /tmp/global-bundle.pem /var/app/current/certs/global-bundle.pem 2>/dev/null || true

      echo "=== Certificate Import Complete ==="